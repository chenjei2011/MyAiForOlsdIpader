<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI åŠ©æ‰‹ - è°ƒè¯•ç‰ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, "Helvetica Neue", Helvetica, Arial, sans-serif;
            background: #f5f5f5;
            height: 100vh;
            overflow: hidden;
            position: relative;
        }
        
        /* å¯†ç ä¿æŠ¤å±‚ */
        .password-layer {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 1000;
            display: -webkit-box;
            display: -webkit-flex;
            display: flex;
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center;
            -webkit-box-pack: center;
            -webkit-justify-content: center;
            justify-content: center;
            -webkit-box-orient: vertical;
            -webkit-flex-direction: column;
            flex-direction: column;
        }
        
        .password-layer.hidden {
            display: none;
        }
        
        .password-box {
            background: white;
            padding: 40px 30px;
            border-radius: 20px;
            width: 85%;
            max-width: 320px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        
        .password-box h2 {
            color: #333;
            margin-bottom: 10px;
            font-size: 22px;
        }
        
        .password-box p {
            color: #999;
            font-size: 14px;
            margin-bottom: 25px;
        }
        
        .password-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 16px;
            text-align: center;
            letter-spacing: 2px;
            margin-bottom: 20px;
            outline: none;
            -webkit-appearance: none;
        }
        
        .password-input:focus {
            border-color: #667eea;
        }
        
        .password-btn {
            width: 100%;
            padding: 15px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            -webkit-appearance: none;
        }
        
        .password-btn:active {
            background: #5a6fd6;
        }
        
        .password-error {
            color: #e74c3c;
            font-size: 14px;
            margin-top: 15px;
            display: none;
        }
        
        .password-error.show {
            display: block;
        }
        
        /* ä¸»ç•Œé¢ */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 100;
        }
        
        .header h1 {
            font-size: 18px;
            font-weight: 600;
        }
        
        .header .status {
            font-size: 12px;
            opacity: 0.9;
            margin-top: 5px;
            min-height: 18px;
        }
        
        .settings-btn {
            position: absolute;
            right: 15px;
            top: 50%;
            -webkit-transform: translateY(-50%);
            transform: translateY(-50%);
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
        }
        
        /* è°ƒè¯•ä¿¡æ¯é¢æ¿ */
        .debug-panel {
            position: fixed;
            top: 70px;
            left: 0;
            right: 0;
            background: #fff3cd;
            border-bottom: 2px solid #ffc107;
            padding: 10px;
            font-size: 12px;
            color: #856404;
            z-index: 98;
            max-height: 100px;
            overflow-y: auto;
            display: none;
        }
        
        .debug-panel.show {
            display: block;
        }
        
        .debug-toggle {
            position: absolute;
            left: 15px;
            top: 50%;
            -webkit-transform: translateY(-50%);
            transform: translateY(-50%);
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
        }
        
        /* è¿›åº¦æ¡ */
        .progress-bar {
            position: fixed;
            top: 70px;
            left: 0;
            right: 0;
            height: 3px;
            background: rgba(102, 126, 234, 0.1);
            z-index: 99;
            display: none;
        }
        
        .progress-bar.active {
            display: block;
        }
        
        .progress-bar.with-debug {
            top: 170px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
            -webkit-transition: width 0.3s ease;
        }
        
        .chat-container {
            position: fixed;
            top: 73px;
            bottom: 60px;
            left: 0;
            right: 0;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 15px;
        }
        
        .chat-container.with-debug {
            top: 173px;
        }
        
        .message {
            margin-bottom: 15px;
            animation: fadeIn 0.3s ease;
            -webkit-animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @-webkit-keyframes fadeIn {
            from { opacity: 0; -webkit-transform: translateY(10px); }
            to { opacity: 1; -webkit-transform: translateY(0); }
        }
        
        .message.user {
            text-align: right;
        }
        
        .message-content {
            display: inline-block;
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 18px;
            font-size: 15px;
            line-height: 1.4;
            word-wrap: break-word;
            text-align: left;
            min-height: 20px;
        }
        
        .message.user .message-content {
            background: #667eea;
            color: white;
            border-bottom-right-radius: 4px;
        }
        
        .message.ai .message-content {
            background: white;
            color: #333;
            border-bottom-left-radius: 4px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        
        .typing-cursor {
            display: inline-block;
            width: 2px;
            height: 16px;
            background: #667eea;
            margin-left: 2px;
            animation: blink 1s infinite;
            -webkit-animation: blink 1s infinite;
            vertical-align: middle;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        @-webkit-keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        .typing-cursor.hidden {
            display: none;
        }
        
        .thinking-content {
            background: #f0f4ff;
            border-left: 3px solid #667eea;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 0 8px 8px 0;
            font-size: 13px;
            color: #555;
            font-style: italic;
        }
        
        .thinking-label {
            color: #667eea;
            font-weight: 600;
            font-size: 12px;
            margin-bottom: 5px;
            font-style: normal;
        }
        
        .message-time {
            font-size: 11px;
            color: #999;
            margin-top: 5px;
            padding: 0 5px;
        }
        
        .loading-container {
            display: none;
            text-align: center;
            padding: 20px;
            background: white;
            border-radius: 18px;
            margin-bottom: 15px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        
        .loading-container.show {
            display: block;
        }
        
        .loading-text {
            color: #667eea;
            font-size: 14px;
            margin-top: 10px;
        }
        
        .loading-dots:after {
            content: '';
            animation: dots 1.5s infinite;
            -webkit-animation: dots 1.5s infinite;
        }
        
        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }
        
        @-webkit-keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            -webkit-animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @-webkit-keyframes spin {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }
        
        .input-container {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 10px 15px;
            border-top: 1px solid #e0e0e0;
            display: -webkit-box;
            display: -webkit-flex;
            display: flex;
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center;
            z-index: 50;
        }
        
        .input-wrapper {
            -webkit-box-flex: 1;
            -webkit-flex: 1;
            flex: 1;
            margin-right: 10px;
        }
        
        #userInput {
            width: 100%;
            border: 1px solid #ddd;
            border-radius: 20px;
            padding: 10px 15px;
            font-size: 15px;
            outline: none;
            -webkit-appearance: none;
        }
        
        #sendBtn {
            background: #667eea;
            color: white;
            border: none;
            border-radius: 20px;
            padding: 10px 20px;
            font-size: 15px;
            cursor: pointer;
            -webkit-appearance: none;
            min-width: 60px;
        }
        
        #sendBtn:active {
            background: #5a6fd6;
        }
        
        #sendBtn:disabled {
            background: #ccc;
        }
        
        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 14px;
            display: none;
            word-break: break-all;
        }
        
        .error-message.show {
            display: block;
        }
        
        .welcome {
            text-align: center;
            color: #999;
            padding: 40px 20px;
        }
        
        .welcome h2 {
            font-size: 20px;
            margin-bottom: 10px;
            color: #667eea;
        }
        
        .welcome p {
            font-size: 14px;
            line-height: 1.6;
        }
        
        .settings-panel {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 200;
            display: none;
        }
        
        .settings-panel.show {
            display: block;
        }
        
        .settings-content {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-radius: 20px 20px 0 0;
            padding: 25px;
            max-height: 70%;
            overflow-y: auto;
        }
        
        .settings-header {
            display: -webkit-box;
            display: -webkit-flex;
            display: flex;
            -webkit-box-pack: justify;
            -webkit-justify-content: space-between;
            justify-content: space-between;
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .settings-header h3 {
            font-size: 18px;
            color: #333;
        }
        
        .close-settings {
            background: none;
            border: none;
            font-size: 24px;
            color: #999;
            cursor: pointer;
        }
        
        .setting-item {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .setting-item:last-child {
            border-bottom: none;
        }
        
        .setting-label {
            display: block;
            font-size: 14px;
            color: #333;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .setting-desc {
            font-size: 12px;
            color: #999;
            margin-bottom: 10px;
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            border-radius: 28px;
            transition: .4s;
            -webkit-transition: .4s;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            border-radius: 50%;
            transition: .4s;
            -webkit-transition: .4s;
        }
        
        input:checked + .toggle-slider {
            background-color: #667eea;
        }
        
        input:checked + .toggle-slider:before {
            -webkit-transform: translateX(22px);
            transform: translateX(22px);
        }
        
        .clear-btn, .logout-btn, .test-btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            cursor: pointer;
            margin-top: 10px;
        }
        
        .clear-btn {
            background: #ffebee;
            color: #c62828;
        }
        
        .logout-btn {
            background: #f5f5f5;
            color: #666;
        }
        
        .test-btn {
            background: #e3f2fd;
            color: #1976d2;
        }
    </style>
</head>
<body>
    <!-- å¯†ç ä¿æŠ¤å±‚ -->
    <div class="password-layer" id="passwordLayer">
        <div class="password-box">
            <h2>ğŸ” å®‰å…¨éªŒè¯</h2>
            <p>è¯·è¾“å…¥è®¿é—®å¯†ç </p>
            <input type="password" class="password-input" id="passwordInput" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" maxlength="20">
            <button class="password-btn" onclick="checkPassword()">è¿›å…¥ç³»ç»Ÿ</button>
            <div class="password-error" id="passwordError">å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•</div>
        </div>
    </div>

    <!-- è®¾ç½®é¢æ¿ -->
    <div class="settings-panel" id="settingsPanel">
        <div class="settings-content">
            <div class="settings-header">
                <h3>âš™ï¸ è®¾ç½®</h3>
                <button class="close-settings" onclick="closeSettings()">Ã—</button>
            </div>
            
            <div class="setting-item">
                <label class="setting-label">æ·±åº¦æ€è€ƒæ¨¡å¼</label>
                <p class="setting-desc">å¼€å¯å AI ä¼šè¿›è¡Œæ›´æ·±å…¥çš„æ¨ç†åˆ†æ</p>
                <label class="toggle-switch">
                    <input type="checkbox" id="thinkingToggle" onchange="toggleThinking()">
                    <span class="toggle-slider"></span>
                </label>
            </div>
            
            <div class="setting-item">
                <label class="setting-label">æµå¼è¾“å‡º</label>
                <p class="setting-desc">å®æ—¶æ˜¾ç¤º AI å›å¤ï¼ˆæ‰“å­—æœºæ•ˆæœï¼‰</p>
                <label class="toggle-switch">
                    <input type="checkbox" id="streamToggle" checked onchange="toggleStream()">
                    <span class="toggle-slider"></span>
                </label>
            </div>
            
            <div class="setting-item">
                <label class="setting-label">ç½‘ç»œæµ‹è¯•</label>
                <p class="setting-desc">æµ‹è¯• API è¿æ¥æ˜¯å¦æ­£å¸¸</p>
                <button class="test-btn" onclick="testConnection()">ğŸ§ª æµ‹è¯•è¿æ¥</button>
            </div>
            
            <div class="setting-item">
                <label class="setting-label">æ¸…é™¤å¯¹è¯å†å²</label>
                <button class="clear-btn" onclick="clearHistory()">ğŸ—‘ï¸ æ¸…é™¤å†å²</button>
            </div>
            
            <div class="setting-item">
                <label class="setting-label">é€€å‡ºç™»å½•</label>
                <button class="logout-btn" onclick="logout()">ğŸšª é€€å‡ºç™»å½•</button>
            </div>
        </div>
    </div>

    <!-- ä¸»ç•Œé¢ -->
    <div class="header">
        <button class="debug-toggle" onclick="toggleDebug()">è°ƒè¯•</button>
        <h1>ğŸ¤– AI æ™ºèƒ½åŠ©æ‰‹</h1>
        <div class="status" id="status">å°±ç»ª</div>
        <button class="settings-btn" onclick="openSettings()">è®¾ç½®</button>
    </div>
    
    <!-- è°ƒè¯•é¢æ¿ -->
    <div class="debug-panel" id="debugPanel"></div>
    
    <!-- è¿›åº¦æ¡ -->
    <div class="progress-bar" id="progressBar">
        <div class="progress-fill" id="progressFill"></div>
    </div>
    
    <div class="chat-container" id="chatContainer">
        <div class="welcome" id="welcome">
            <h2>æ¬¢è¿ä½¿ç”¨ AI åŠ©æ‰‹</h2>
            <p>åŸºäºæ™ºè°±æ¸…è¨€ GLM-4.6V-Flash æ¨¡å‹<br>æ”¯æŒæµå¼è¾“å‡ºä¸æ·±åº¦æ€è€ƒ<br>åœ¨ä¸‹æ–¹è¾“å…¥æ¡†å¼€å§‹å¯¹è¯</p>
        </div>
        
        <!-- åŠ è½½å®¹å™¨ -->
        <div class="loading-container" id="loadingBox">
            <div class="spinner"></div>
            <div class="loading-text">AI æ­£åœ¨æ€è€ƒ<span class="loading-dots"></span></div>
        </div>
    </div>
    
    <div class="error-message" id="errorMsg"></div>
    
    <div class="input-container">
        <div class="input-wrapper">
            <input type="text" id="userInput" placeholder="è¾“å…¥æ¶ˆæ¯..." autocomplete="off">
        </div>
        <button id="sendBtn" onclick="sendMessage()">å‘é€</button>
    </div>

    <script>
        // ==================== è°ƒè¯•å·¥å…· ====================
        var debugMode = false;
        var debugPanel = document.getElementById('debugPanel');
        
        function log(msg) {
            console.log(msg);
            if (debugMode && debugPanel) {
                var line = document.createElement('div');
                line.textContent = new Date().toLocaleTimeString() + ': ' + msg;
                debugPanel.appendChild(line);
                debugPanel.scrollTop = debugPanel.scrollHeight;
            }
        }
        
        function toggleDebug() {
            debugMode = !debugMode;
            var chatContainer = document.getElementById('chatContainer');
            var progressBar = document.getElementById('progressBar');
            
            if (debugMode) {
                debugPanel.className = 'debug-panel show';
                chatContainer.className = 'chat-container with-debug';
                progressBar.className = 'progress-bar with-debug';
                log('è°ƒè¯•æ¨¡å¼å·²å¼€å¯');
            } else {
                debugPanel.className = 'debug-panel';
                chatContainer.className = 'chat-container';
                progressBar.className = 'progress-bar';
            }
        }
        
        // ==================== åŠ å¯†æ¨¡å— ====================
        var ENCRYPTED_KEY_PARTS = ['62de8f8245034489a009e72cad9c0795', 'TiznOPeDsVYqBw4P'];
        
        function reconstructApiKey() {
            return ENCRYPTED_KEY_PARTS[0] + '.' + ENCRYPTED_KEY_PARTS[1];
        }
        
        // Cookie æ“ä½œ
        function setCookie(name, value, days) {
            var expires = '';
            if (days) {
                var date = new Date();
                date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
                expires = '; expires=' + date.toGMTString();
            }
            document.cookie = name + '=' + encodeURIComponent(value) + expires + '; path=/';
        }
        
        function getCookie(name) {
            var nameEQ = name + '=';
            var ca = document.cookie.split(';');
            for (var i = 0; i < ca.length; i++) {
                var c = ca[i];
                while (c.charAt(0) === ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) === 0) return decodeURIComponent(c.substring(nameEQ.length, c.length));
            }
            return null;
        }
        
        function clearCookie(name) {
            document.cookie = name + '=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/';
        }
        
        function hashString(str) {
            var hash = 0x9e3779b9;
            for (var i = 0; i < str.length; i++) {
                var char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return Math.abs(hash).toString(16);
        }
        
        // ==================== é…ç½® ====================
        var CONFIG = {
            API_URL: 'https://open.bigmodel.cn/api/paas/v4/chat/completions',
            MODEL: 'GLM-4.6V-Flash',
            PASSWORD: 'NullptrVoid',
            STREAM_CHUNK_SIZE: 2,
            STREAM_DELAY: 40
        };
        
        var messages = [];
        var isProcessing = false;
        var thinkingEnabled = false;
        var streamEnabled = true;
        var currentStreamInterval = null;
        
        // ==================== DOM å…ƒç´  ====================
        var passwordLayer = document.getElementById('passwordLayer');
        var passwordInput = document.getElementById('passwordInput');
        var passwordError = document.getElementById('passwordError');
        var chatContainer = document.getElementById('chatContainer');
        var userInput = document.getElementById('userInput');
        var sendBtn = document.getElementById('sendBtn');
        var loadingBox = document.getElementById('loadingBox');
        var welcome = document.getElementById('welcome');
        var status = document.getElementById('status');
        var settingsPanel = document.getElementById('settingsPanel');
        var thinkingToggle = document.getElementById('thinkingToggle');
        var streamToggle = document.getElementById('streamToggle');
        var progressBar = document.getElementById('progressBar');
        var progressFill = document.getElementById('progressFill');
        var errorMsg = document.getElementById('errorMsg');
        
        // ==================== å¯†ç éªŒè¯ ====================
        function checkPassword() {
            var input = passwordInput.value;
            if (input === CONFIG.PASSWORD) {
                setCookie('ai_auth', hashString(CONFIG.PASSWORD + 'salt123'), 7);
                passwordLayer.className = 'password-layer hidden';
                initApp();
            } else {
                passwordError.className = 'password-error show';
                passwordInput.value = '';
                setTimeout(function() { passwordError.className = 'password-error'; }, 3000);
            }
        }
        
        function checkAuth() {
            var auth = getCookie('ai_auth');
            var expectedHash = hashString(CONFIG.PASSWORD + 'salt123');
            if (auth === expectedHash) {
                passwordLayer.className = 'password-layer hidden';
                initApp();
                return true;
            }
            return false;
        }
        
        function logout() {
            clearCookie('ai_auth');
            window.location.reload();
        }
        
        // ==================== åˆå§‹åŒ– ====================
        function initApp() {
            var savedThinking = getCookie('thinking_mode');
            if (savedThinking === 'true') {
                thinkingEnabled = true;
                thinkingToggle.checked = true;
            }
            
            var savedStream = getCookie('stream_mode');
            if (savedStream === 'false') {
                streamEnabled = false;
                streamToggle.checked = false;
            }
            
            userInput.focus();
            log('åº”ç”¨åˆå§‹åŒ–å®Œæˆ');
        }
        
        // ==================== è®¾ç½® ====================
        function openSettings() { settingsPanel.className = 'settings-panel show'; }
        function closeSettings() { settingsPanel.className = 'settings-panel'; }
        
        function toggleThinking() {
            thinkingEnabled = thinkingToggle.checked;
            setCookie('thinking_mode', thinkingEnabled, 30);
            status.textContent = thinkingEnabled ? 'æ·±åº¦æ€è€ƒå·²å¼€å¯' : 'æ ‡å‡†æ¨¡å¼';
            setTimeout(function() { status.textContent = 'å°±ç»ª'; }, 2000);
        }
        
        function toggleStream() {
            streamEnabled = streamToggle.checked;
            setCookie('stream_mode', streamEnabled, 30);
            status.textContent = streamEnabled ? 'æµå¼è¾“å‡ºå·²å¼€å¯' : 'æµå¼è¾“å‡ºå·²å…³é—­';
            setTimeout(function() { status.textContent = 'å°±ç»ª'; }, 2000);
        }
        
        function clearHistory() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰å¯¹è¯å†å²å—ï¼Ÿ')) {
                messages = [];
                chatContainer.innerHTML = '<div class="welcome" id="welcome"><h2>æ¬¢è¿ä½¿ç”¨ AI åŠ©æ‰‹</h2><p>åŸºäºæ™ºè°±æ¸…è¨€ GLM-4.6V-Flash æ¨¡å‹<br>æ”¯æŒæµå¼è¾“å‡ºä¸æ·±åº¦æ€è€ƒ<br>åœ¨ä¸‹æ–¹è¾“å…¥æ¡†å¼€å§‹å¯¹è¯</p></div><div class="loading-container" id="loadingBox"><div class="spinner"></div><div class="loading-text">AI æ­£åœ¨æ€è€ƒ<span class="loading-dots"></span></div></div>';
                welcome = document.getElementById('welcome');
                loadingBox = document.getElementById('loadingBox');
                closeSettings();
            }
        }
        
        // ==================== ç½‘ç»œæµ‹è¯• ====================
        function testConnection() {
            log('å¼€å§‹æµ‹è¯• API è¿æ¥...');
            status.textContent = 'æµ‹è¯•ä¸­...';
            
            var xhr = new XMLHttpRequest();
            xhr.open('POST', CONFIG.API_URL, true);
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.setRequestHeader('Authorization', 'Bearer ' + reconstructApiKey());
            
            var testData = {
                model: CONFIG.MODEL,
                messages: [{role: 'user', content: 'ä½ å¥½'}],
                max_tokens: 10
            };
            
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    log('æµ‹è¯•å®Œæˆï¼ŒçŠ¶æ€ç : ' + xhr.status);
                    log('å“åº”å†…å®¹: ' + xhr.responseText.substring(0, 200));
                    
                    if (xhr.status === 200) {
                        alert('âœ… è¿æ¥æˆåŠŸï¼API å·¥ä½œæ­£å¸¸');
                        status.textContent = 'è¿æ¥æ­£å¸¸';
                    } else {
                        alert('âŒ è¿æ¥å¤±è´¥: ' + xhr.status + '\n' + xhr.responseText.substring(0, 100));
                        status.textContent = 'è¿æ¥å¤±è´¥';
                    }
                    setTimeout(function() { status.textContent = 'å°±ç»ª'; }, 3000);
                }
            };
            
            xhr.onerror = function() {
                log('æµ‹è¯•å¤±è´¥: ç½‘ç»œé”™è¯¯');
                alert('âŒ ç½‘ç»œé”™è¯¯ï¼Œæ— æ³•è¿æ¥åˆ° API');
                status.textContent = 'ç½‘ç»œé”™è¯¯';
            };
            
            xhr.timeout = 30000;
            xhr.ontimeout = function() {
                log('æµ‹è¯•å¤±è´¥: è¶…æ—¶');
                alert('âŒ è¿æ¥è¶…æ—¶');
                status.textContent = 'è¶…æ—¶';
            };
            
            try {
                xhr.send(JSON.stringify(testData));
                log('æµ‹è¯•è¯·æ±‚å·²å‘é€');
            } catch (e) {
                log('å‘é€å¤±è´¥: ' + e.message);
                alert('å‘é€å¤±è´¥: ' + e.message);
            }
        }
        
        // ==================== è¿›åº¦æ¡æ§åˆ¶ ====================
        function showProgress() {
            progressBar.className = debugMode ? 'progress-bar active with-debug' : 'progress-bar active';
            progressFill.style.width = '0%';
            
            var width = 0;
            var interval = setInterval(function() {
                if (width >= 90) {
                    clearInterval(interval);
                } else {
                    width += Math.random() * 10;
                    if (width > 90) width = 90;
                    progressFill.style.width = width + '%';
                }
            }, 300);
            
            return interval;
        }
        
        function hideProgress() {
            progressFill.style.width = '100%';
            setTimeout(function() {
                progressBar.className = debugMode ? 'progress-bar with-debug' : 'progress-bar';
                progressFill.style.width = '0%';
            }, 300);
        }
        
        // ==================== æ¶ˆæ¯å¤„ç† ====================
        function getTime() {
            var now = new Date();
            var hours = now.getHours();
            var minutes = now.getMinutes();
            return (hours < 10 ? '0' : '') + hours + ':' + (minutes < 10 ? '0' : '') + minutes;
        }
        
        function createMessageElement(isUser) {
            if (welcome) welcome.style.display = 'none';
            
            var messageDiv = document.createElement('div');
            messageDiv.className = 'message ' + (isUser ? 'user' : 'ai');
            
            var contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            var timeDiv = document.createElement('div');
            timeDiv.className = 'message-time';
            timeDiv.textContent = getTime();
            
            messageDiv.appendChild(contentDiv);
            messageDiv.appendChild(timeDiv);
            chatContainer.appendChild(messageDiv);
            
            return { messageDiv: messageDiv, contentDiv: contentDiv };
        }
        
        // ==================== æµå¼è¾“å‡º ====================
        function streamText(element, text, callback) {
            if (!streamEnabled) {
                element.textContent = text;
                if (callback) callback();
                return;
            }
            
            var index = 0;
            var currentText = '';
            var cursor = document.createElement('span');
            cursor.className = 'typing-cursor';
            
            element.appendChild(cursor);
            
            currentStreamInterval = setInterval(function() {
                if (index < text.length) {
                    var chunk = text.substr(index, CONFIG.STREAM_CHUNK_SIZE);
                    currentText += chunk;
                    element.textContent = currentText;
                    element.appendChild(cursor);
                    index += CONFIG.STREAM_CHUNK_SIZE;
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                } else {
                    clearInterval(currentStreamInterval);
                    cursor.className = 'typing-cursor hidden';
                    if (callback) callback();
                }
            }, CONFIG.STREAM_DELAY);
        }
        
        function stopStream() {
            if (currentStreamInterval) {
                clearInterval(currentStreamInterval);
                currentStreamInterval = null;
            }
        }
        
        // ==================== å‘é€æ¶ˆæ¯ ====================
        function showError(msg) {
            errorMsg.textContent = msg;
            errorMsg.className = 'error-message show';
            log('é”™è¯¯: ' + msg);
            setTimeout(function() { errorMsg.className = 'error-message'; }, 8000);
        }
        
        function sendMessage() {
            if (isProcessing) {
                log('æ­£åœ¨å¤„ç†ä¸­ï¼Œå¿½ç•¥é‡å¤æäº¤');
                return;
            }
            
            var content = userInput.value.trim();
            if (!content) {
                log('è¾“å…¥ä¸ºç©º');
                return;
            }
            
            log('å¼€å§‹å‘é€æ¶ˆæ¯: ' + content.substring(0, 20) + '...');
            stopStream();
            
            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            var userElements = createMessageElement(true);
            userElements.contentDiv.textContent = content;
            messages.push({ role: 'user', content: content });
            
            userInput.value = '';
            isProcessing = true;
            sendBtn.disabled = true;
            sendBtn.textContent = '...';
            
            // æ˜¾ç¤ºåŠ è½½
            loadingBox.className = 'loading-container show';
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            var progressInterval = showProgress();
            status.textContent = thinkingEnabled ? 'æ·±åº¦æ€è€ƒä¸­...' : 'AI æ€è€ƒä¸­...';
            
            // å‡†å¤‡è¯·æ±‚
            var requestBody = {
                model: CONFIG.MODEL,
                messages: messages,
                temperature: 0.7,
                max_tokens: 2000
            };
            
            if (thinkingEnabled) {
                requestBody.thinking = { type: "enabled" };
            }
            
            log('è¯·æ±‚ä½“: ' + JSON.stringify(requestBody).substring(0, 100) + '...');
            
            var xhr = new XMLHttpRequest();
            
            xhr.onreadystatechange = function() {
                log('çŠ¶æ€å˜åŒ–: readyState=' + xhr.readyState + ', status=' + xhr.status);
                
                if (xhr.readyState === 4) {
                    clearInterval(progressInterval);
                    loadingBox.className = 'loading-container';
                    
                    log('è¯·æ±‚å®Œæˆï¼ŒçŠ¶æ€ç : ' + xhr.status);
                    log('å“åº”é•¿åº¦: ' + xhr.responseText.length);
                    
                    if (xhr.status === 0) {
                        hideProgress();
                        showError('ç½‘ç»œé”™è¯¯: æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ (CORS æˆ–ç½‘ç»œé—®é¢˜)');
                        isProcessing = false;
                        sendBtn.disabled = false;
                        sendBtn.textContent = 'å‘é€';
                        status.textContent = 'ç½‘ç»œé”™è¯¯';
                        return;
                    }
                    
                    if (xhr.status === 200) {
                        try {
                            var response = JSON.parse(xhr.responseText);
                            log('è§£ææˆåŠŸ: ' + JSON.stringify(response).substring(0, 100));
                            
                            if (response.choices && response.choices[0] && response.choices[0].message) {
                                var message = response.choices[0].message;
                                var aiContent = message.content;
                                var thinking = message.reasoning_content;
                                
                                log('æ”¶åˆ°å›å¤ï¼Œé•¿åº¦: ' + aiContent.length);
                                
                                // åˆ›å»º AI æ¶ˆæ¯å…ƒç´ 
                                var aiElements = createMessageElement(false);
                                
                                // æ˜¾ç¤ºæ€è€ƒè¿‡ç¨‹
                                if (thinking) {
                                    var thinkingDiv = document.createElement('div');
                                    thinkingDiv.className = 'thinking-content';
                                    thinkingDiv.innerHTML = '<div class="thinking-label">ğŸ’­ æ€è€ƒè¿‡ç¨‹</div><div>' + thinking + '</div>';
                                    aiElements.contentDiv.appendChild(thinkingDiv);
                                }
                                
                                var mainContent = document.createElement('div');
                                aiElements.contentDiv.appendChild(mainContent);
                                
                                status.textContent = 'è¾“å‡ºä¸­...';
                                
                                streamText(mainContent, aiContent, function() {
                                    hideProgress();
                                    isProcessing = false;
                                    sendBtn.disabled = false;
                                    sendBtn.textContent = 'å‘é€';
                                    status.textContent = 'å°±ç»ª';
                                    
                                    var pushMsg = { role: 'assistant', content: aiContent };
                                    if (thinking) pushMsg.reasoning_content = thinking;
                                    messages.push(pushMsg);
                                    
                                    log('å›å¤å®Œæˆ');
                                });
                                
                            } else if (response.error) {
                                throw new Error('API é”™è¯¯: ' + (response.error.message || 'æœªçŸ¥é”™è¯¯'));
                            } else {
                                throw new Error('å“åº”æ ¼å¼é”™è¯¯: ç¼ºå°‘ choices');
                            }
                        } catch (e) {
                            hideProgress();
                            log('è§£æé”™è¯¯: ' + e.message);
                            showError('è§£æå¤±è´¥: ' + e.message + '\nåŸå§‹å“åº”: ' + xhr.responseText.substring(0, 100));
                            isProcessing = false;
                            sendBtn.disabled = false;
                            sendBtn.textContent = 'å‘é€';
                            status.textContent = 'é”™è¯¯';
                        }
                    } else {
                        hideProgress();
                        var errorText = 'HTTP é”™è¯¯: ' + xhr.status;
                        try {
                            var errorData = JSON.parse(xhr.responseText);
                            if (errorData.error && errorData.error.message) {
                                errorText = errorData.error.message;
                            }
                        } catch (e) {
                            errorText += ' - ' + xhr.responseText.substring(0, 100);
                        }
                        log('è¯·æ±‚å¤±è´¥: ' + errorText);
                        showError(errorText);
                        isProcessing = false;
                        sendBtn.disabled = false;
                        sendBtn.textContent = 'å‘é€';
                        status.textContent = 'é”™è¯¯ ' + xhr.status;
                    }
                }
            };
            
            xhr.onerror = function() {
                clearInterval(progressInterval);
                hideProgress();
                loadingBox.className = 'loading-container';
                log('XHR onerror è§¦å‘');
                showError('ç½‘ç»œè¯·æ±‚å¤±è´¥ (CORS æˆ–è¿æ¥é—®é¢˜)\nè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ï¼Œæˆ–å°è¯•ç‚¹å‡»å·¦ä¸Šè§’"è°ƒè¯•"æŒ‰é’®æŸ¥çœ‹è¯¦æƒ…');
                isProcessing = false;
                sendBtn.disabled = false;
                sendBtn.textContent = 'å‘é€';
                status.textContent = 'ç½‘ç»œé”™è¯¯';
            };
            
            xhr.ontimeout = function() {
                clearInterval(progressInterval);
                hideProgress();
                loadingBox.className = 'loading-container';
                log('è¯·æ±‚è¶…æ—¶');
                showError('è¯·æ±‚è¶…æ—¶ (60ç§’)');
                isProcessing = false;
                sendBtn.disabled = false;
                sendBtn.textContent = 'å‘é€';
                status.textContent = 'è¶…æ—¶';
            };
            
            xhr.timeout = 60000;
            
            try {
                xhr.open('POST', CONFIG.API_URL, true);
                xhr.setRequestHeader('Content-Type', 'application/json');
                xhr.setRequestHeader('Authorization', 'Bearer ' + reconstructApiKey());
                log('XHR å·²æ‰“å¼€ï¼Œå‡†å¤‡å‘é€');
                xhr.send(JSON.stringify(requestBody));
                log('è¯·æ±‚å·²å‘é€');
            } catch (e) {
                clearInterval(progressInterval);
                hideProgress();
                loadingBox.className = 'loading-container';
                log('å‘é€å¼‚å¸¸: ' + e.message);
                showError('å‘é€å¤±è´¥: ' + e.message);
                isProcessing = false;
                sendBtn.disabled = false;
                sendBtn.textContent = 'å‘é€';
                status.textContent = 'é”™è¯¯';
            }
        }
        
        // ==================== äº‹ä»¶ç›‘å¬ ====================
        passwordInput.onkeypress = function(e) {
            if (e.keyCode === 13) checkPassword();
        };
        
        userInput.onkeypress = function(e) {
            if (e.keyCode === 13) sendMessage();
        };
        
        settingsPanel.onclick = function(e) {
            if (e.target === settingsPanel) closeSettings();
        };
        
        window.onload = function() {
            log('é¡µé¢åŠ è½½å®Œæˆ');
            if (!checkAuth()) {
                passwordInput.focus();
            }
        };
    </script>
</body>
</html>
